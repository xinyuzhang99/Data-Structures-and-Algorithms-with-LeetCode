# SQL Cheatsheet

## 1. SELECT/UPDATE/DELETE/INSERT

- `SELECT` - extract data from a database

  ```sql
  SELECT column1, column2, ...  # field name
  FROM table_name
  
  # select all fields in the table
  SELECT * FROM table_name;  # = SELECT COUNT(1) FROM table_name;
  
  # SELECT DISTINCT: return only distinct (different/unique) values
  SELECT DISTINCT column1, column2, ...
  FROM table_name;
  
  # list the number of different (distinct) field records
  SELECT COUNT(DISTINCT Country) FROM Customers;
  ```

  - <u>Aliases</u>

    --> give a table or a column a temporary name

    ```sql
    SELECT column1_name AS alias1_name, column2_name AS alias2_name
    FROM table_name;
    
    SELECT column_name(s)
    FROM table_name AS alias_name;
    
    # Note: It requires double quotation marks or square brackets if the alias name contains spaces:
    SELECT ContactName AS [Contact Person]
    FROM Customers;
    ```

    Example 1:

    ```sql
    # combine multiple columns to create an alias
    SELECT CustomerName, Address + ', ' + PostalCode + ' ' + City + ', ' + Country AS Address
    FROM Customers;
    ```

    Result:

    <img src="/Users/xinyuzhang/Library/Application Support/typora-user-images/image-20230523172707244.png" alt="image-20230523172707244" style="zoom:50%;" />

    Example 2: select all the orders from the customer with CustomerID=4 (Around the Horn). We use the "Customers" and "Orders" tables, and give them the table aliases of "c" and "o" respectively

    ```sql
    # with aliases
    SELECT o.OrderID, o.OrderDate, c.CustomerName
    FROM Customers AS c, Orders AS o
    WHERE c.CustomerName='Around the Horn' AND c.CustomerID=o.CustomerID;
    
    # without aliases
    SELECT Orders.OrderID, Orders.OrderDate, Customers.CustomerName
    FROM Customers, Orders
    WHERE Customers.CustomerName='Around the Horn' AND Customers.CustomerID=Orders.CustomerID;
    ```

  - `SELECT INTO`: copy data from one table into a new table

    ```sql
    # Copy all columns into a new table
    SELECT *
    INTO newtable [IN externaldb]
    FROM oldtable
    WHERE condition;
    
    # Copy only some columns into a new table
    SELECT column1, column2, column3, ...
    INTO newtable [IN externaldb]
    FROM oldtable
    WHERE condition;
    
    # Create a new, empty table using the schema of another
    SELECT * INTO newtable
    FROM oldtable
    WHERE 1 = 0;  # return no data --> create a new table
    ```

    Example:

    ```sql
    SELECT Customers.CustomerName, Orders.OrderID
    INTO CustomersOrderBackup2017
    FROM Customers
    LEFT JOIN Orders ON Customers.CustomerID = Orders.CustomerID;
    ```

- `WHERE`: used in `SELECT`, `UPDATE`, `DELETE` statements to filter records

  ```sql
  SELECT * FROM Customers
  WHERE Country='Mexico';  # or: WHERE CustomerID=1;
  ```

  - <u>Operators</u>

    - `=/>/</>=/<=`

    - `<>/!=`: not equal

    - `BETWEEN`: select values between a certain range. <u>The `BETWEEN` operator is inclusive []</u>

      ```sql
      SELECT column_name(s)
      FROM table_name
      WHERE column_name BETWEEN value1 AND value2;
      
      # Example: BETWEEN Number Values
      SELECT * FROM Products
      WHERE Price BETWEEN 10 AND 20 
      AND CategoryID NOT IN (1, 2, 3);
      
      # Example: BETWEEN Text Values
      SELECT * FROM Products
      WHERE ProductName BETWEEN 'Carnarvon Tigers' AND 'Mozzarella di Giovanni'
      ORDER BY ProductName;
      
      # Example: BETWEEN Dates
      SELECT * FROM Orders
      WHERE OrderDate BETWEEN '1996-07-01' AND '1996-07-31'; # or: #07/01/1996# AND #07/31/1996# 
      ```

    - `LIKE`: search for a specified pattern. Eg. `SELECT * FROM Customers WHERE City LIKE 's%'`: select cities which start at 's'

      -  The percent sign (%) represents **zero, one, or multiple** characters
      -  The underscore sign (_) represents one, single character

      <img src="/Users/xinyuzhang/Library/Application Support/typora-user-images/image-20230515172503004.png" alt="image-20230515172503004" style="zoom:50%;" />

      ```sql
      SELECT * FROM Customers
      WHERE CustomerName NOT LIKE 'a%'  # not start with 'a'
      ```

      - <u>Wildcard Characters</u>: used with the `LIKE` operator

        ![image-20230515174505491](/Users/xinyuzhang/Library/Application Support/typora-user-images/image-20230515174505491.png)

        All the wildcards can also be used in combinations!

        ```sql
        # Example
        SELECT * 
        FROM Customers
        WHERE City LIKE '[a-c]%'|'[abc]%'; # start with "a""b""c"
        WHERE City LIKE '[!bsp]%'; # = WHERE City NOT LIKE '[bsp]%'
        ```

    - `IN`: To specify multiple possible values for a column.

      Eg. `SELECT * FROM Customers WHERE City IN ('Paris','London');`

      ```sql
      SELECT column_name(s)
      FROM table_name
      WHERE column_name IN (value1, value2, ...);
      
      SELECT column_name(s)
      FROM table_name
      WHERE column_name IN (SELECT STATEMENT);
      
      ## Example:
      SELECT * FROM Customers
      WHERE Country IN ('Germany', 'France', 'UK');
      
      # Select all customers from the same countries as the Suppliers
      SELECT * FROM Customers
      WHERE Country IN (SELECT Country FROM Suppliers);
      ```

    - `AND/OR/NOT`: 

      ```sql
      SELECT * FROM Customers WHERE Country='Germany' AND (City='Berlin' OR City='MÃ¼nchen');
      
      SELECT * FROM Customers
      WHERE NOT Country='Germany' AND NOT Country='USA'
      ```

- `ORDER BY`: sort the result-set in ascending or descending order

  ```sql
  SELECT column1, column2, ...
  FROM table_name
  ORDER BY column1, column2, ... ASC|DESC;  # Ascending by default
  
  # Example
  SELECT * FROM Customers
  ORDER BY Country, CustomerName;  # order by Country, but if some rows have the same Country, order them by CustomerName
  
  SELECT * FROM Customers
  ORDER BY Country ASC, CustomerName DESC; # sort ascending by "Country" and descending by "CustomerName"
  ```

- `GROUP BY`: group **rows that have the same values** into summary rows

- `INSERT INTO`: insert new records in a table

  - Specify both the column names and the values to be inserted:

    ```sql
    INSERT INTO table_name (column1, column2, column3, ...)
    VALUES (value1, value2, value3, ...);
    ```

  - Add values for all the columns of the table:

    ```sql
    INSERT INTO table_name
    VALUES (value1, value2, value3, ...);
    ```

  - Copy all columns from one table to another table:

    ```sql
    INSERT INTO table2
    SELECT * FROM table1
    WHERE condition;
    ```

  - Copy only some columns from one table into another table:

    ```sql
    INSERT INTO table2 (column1, column2, column3, ...)
    SELECT column1, column2, column3, ...
    FROM table1
    WHERE condition;
    ```

- NULL values

  ```sql
  SELECT column_names
  FROM table_name
  WHERE column_name IS NULL;  # or: IS NOT NULL
  ```

- `TOP, LIMIT, FETCH FIRST or ROWNUM`

  ```sql
  ## SELECT TOP: specify the number of records to return
  # SQL Server/ MS Access Syntax
  SELECT TOP number|percent column_name(s)|*
  FROM table_name
  WHERE condition;
  
  # Important!!: MySQL Syntax
  SELECT column_name(s)
  FROM table_name
  WHERE condition
  LIMIT number;
  # LIMIT K OFFSET X; --> from xth row, return K records after
  
  # Eg.
  SELECT TOP 3 *
  FROM Customers
  WHERE Country='Germany'
  ```

- `Min/Max`: return the `min/max` values of the selected column

  ```sql
  ## Min()
  SELECT MIN(column_name)
  FROM table_name
  WHERE condition;
  
  ## Max()
  SELECT MAX(column_name)
  FROM table_name
  WHERE condition;
  
  ## Eg.
  SELECT MIN(Price) FROM Products;  # Result: MIN(Price): 2.5
  SELECT MIN(Price) FROM Products AS SmallestPrice; # Result: SmallestPrice: 2.5
  ```

- `COUNT(), AVG(), SUM()`

  ```sql
  ## Count(): return the number of rows that matches a specified criterion
  SELECT COUNT(column_name)
  FROM table_name
  WHERE condition;
  
  ## AVG(): return the average value of a numeric column
  SELECT AVG(column_name)
  FROM table_name
  WHERE condition;
  
  ## SUM(): return the total sum of a numeric column
  SELECT SUM(column_name)
  FROM table_name
  WHERE condition;
  
  SELECT SUM(Quantity)
  FROM OrderDetails;
  ```

  - NULL values are ignored during count/avg/sum

- `UPDATE` - update data in a database

  ```sql
  UPDATE table_name
  SET column1=value1, column2=value2, ...
  WHERE condition;  # specify which record(s) that should be updated. 
  # If you omit the WHERE clause, all records in the table will be updated!
  
  UPDATE Customers
  SET ContactName='', City=''
  WHERE CustomerID=1
  ```

- `DELETE` - delete data from a database

  ```SQL
  DELETE FROM table_name WHERE condition;
  ```

- `EXISTS`: test for the existence of any record in a subquery --> return TRUE if the subquery returns one or more records

  ```sql
  SELECT column_name(s)
  FROM table_name
  WHERE EXISTS
  (SELECT column_name FROM table_name WHERE condition);
  ```

- `ANY/ALL`: perform a **comparison** between a single column value and a range of other values

  - The `ANY` operator:

    - return a boolean value as a result
    - return TRUE if ANY of the subquery values meet the condition

    `ANY` means that the condition will be true if the operation is true for any of the values in the range.

    ```sql
    SELECT column_name(s)
    FROM table_name
    WHERE column_name operator ANY
      (SELECT column_name
      FROM table_name
      WHERE condition);
    ```

  - The `ALL` operator:

    - return a boolean value as a result
    - return TRUE if ALL of the subquery values meet the condition
    - is used with `SELECT`, `WHERE` and `HAVING` statements

    `ALL` means that the condition will be true only if the operation is true for all values in the range. 

    ```sql
    # ALL Syntax With SELECT
    SELECT ALL column_name(s)   # list all elements in the column
    FROM table_name
    WHERE condition;
    
    # ALL Syntax With WHERE or HAVING
    SELECT column_name(s)
    FROM table_name
    WHERE column_name operator ALL
      (SELECT column_name
      FROM table_name
      WHERE condition);
    ```

- `CASE`: like `if-then-else` statement

  ```sql
  CASE
      WHEN condition1 THEN result1
      WHEN condition2 THEN result2
      WHEN conditionN THEN resultN
      ELSE result
  END
  AS new_column_name;
  ```

## 2. JOIN / UNION

--> used to combine rows from two or more tables, based on a related column between them.

- Here are the different types of the JOINs in SQL:

  - `(INNER) JOIN`: Returns records that have matching values in both tables
  - `LEFT (OUTER) JOIN`: Returns **all records from the left** table, and the **matched records from the right** table
  - `RIGHT (OUTER) JOIN`: Returns **all records from the right** table, and the **matched records from the left** table
  - `FULL (OUTER) JOIN`: Returns all records when there is a match in either left or right table
  - `CROSS JOIN`: return all records from both tables (table1 and table2)

  <img src="/Users/xinyuzhang/Library/Application Support/typora-user-images/image-20230523180059886.png" alt="image-20230523180059886" style="zoom: 50%;" />

- `INNER JOIN`: select records that have matching values in both tables

  ```sql
  SELECT column_name(s)    # the column_name(s) will be the shown columns in the final table
  FROM table1
  INNER JOIN table2
  ON table1.column_name = table2.column_name;
  
  # Join three tables
  SELECT Orders.OrderID, Customers.CustomerName, Shippers.ShipperName
  FROM ((Orders
  INNER JOIN Customers ON Orders.CustomerID = Customers.CustomerID)
  INNER JOIN Shippers ON Orders.ShipperID = Shippers.ShipperID);
  ```

- `LEFT JOIN`: return all records from the left table (table1), and the matching records from the right table (table2). If there are no matching records from the right table, the value will be NULL.

  ```sql
  SELECT column_name(s)
  FROM table1
  LEFT JOIN table2
  ON table1.column_name = table2.column_name;
  ```

- `RIGHT JOIN`: return all records from the right table (table2), and the matching records from the left table (table1). If there are no matching records from the left table, the value will be NULL.

  ```sql
  SELECT column_name(s)
  FROM table1
  RIGHT JOIN table2
  ON table1.column_name = table2.column_name;

- `FULL OUTER JOIN`: return all records when there is a match in left (table1) **<u>or</u>** right (table2) table records

  ```sql
  SELECT column_name(s)
  FROM table1
  FULL OUTER JOIN table2   # cannot do in MySQL
  ON table1.column_name = table2.column_name
  WHERE condition;
  ```

  --> even if there aren't matches, also will be listed

  - Implement **OUTER JOIN** in MySQL by taking a LEFT JOIN and RIGHT JOIN union

    ```sql
    SELECT column_name(s)
    FROM
    	(SELECT * FROM table 1 LEFT JOIN table 2 USING()
       UNION
       SELECT * FROM table 1 RIGHT JOIN table 2 USING())
    AS new_table_name     # Important!!
    WHERE condition;
  
- `CROSS JOIN`: return all records from both tables

  <font color=red>--> perform a cartesian product between two tables --> Â return all matching records from both tables whether the other table matches or not/all possible combinations of all rows</font>

  - Have no `ON` clause because you're just joining everything to everything
  - `inner join` without `on` condition = `cross join`

  ![MySQL CROSS JOIN](https://www.w3schools.com/mysql/img_crossjoin.png)

  ```sql
  SELECT column_name(s)
  FROM table1
  CROSS JOIN table2;
  ```

  - Use `CROSS JOIN` and `LEFT JOIN/RIGHT JOIN` to concatenate three tables

    ```sql
    SELECT column_name(s)
    FROM table1 CROSS JOIN table2
    LEFT JOIN table 3 ON ...;

- Self join: the table is joined with itself <font color=blue>**[used when there exists <u>duplicate</u>]**</font>

  ```sql
  SELECT column_name(s)
  FROM table1 T1, table1 T2  # T1 and T2 are different table aliases for the same table.
  WHERE condition;
  ```

  Example: match customers that are from the same city

  ```sql
  SELECT A.CustomerName AS CustomerName1, B.CustomerName AS CustomerName2, A.City
  FROM Customers A, Customers B    # Customers is the table
  WHERE A.CustomerID <> B.CustomerID  # <>: not equal
  AND A.City = B.City
  ORDER BY A.City;
  ```

- `UNION`: combine the result-set of two or more `SELECT` statements ==[Unionè¿æ¥è¡]==

  - Every `SELECT` statement within `UNION` must have the **same number of columns**
  - The columns must also have **similar data types**
  - The columns in every `SELECT` statement must also be in the **same order**
  - **Note:** The column names in the result-set are usually equal to the column names in the first `SELECT` statement.

  ```sql
  # UNION: show only distinct values
  SELECT column_name(s) FROM table1
  UNION
  SELECT column_name(s) FROM table2;
  
  # UNION ALL: show duplicate values
  SELECT column_name(s) FROM table1
  UNION ALL
  SELECT column_name(s) FROM table2;
  ```

## 3. 

- `CREATE DATABASE` - creates a new database
- `ALTER DATABASE` - modifies a database
- `CREATE TABLE` - creates a new table
- `ALTER TABLE` - modifies a table
- `DROP TABLE` - deletes a table
- `CREATE INDEX` - creates an index (search key)
- `DROP INDEX` - deletes an index

## 4. MySQL String Functions

- `UPPER(A)/LOWER(A)` (where A is a string)

- `SUBSTR(A,index,length)`: extract the substring (length is optional)

- `CONCAT(A,B)`: concat two strings A + B

- `GROUP_CONCAT()`: 

  ```sql
  GROUP_CONCAT(DISTINCT expression   # å¨è¿æ¥åç»ä¹åæ¶é¤ç»ä¸­çéå¤å¼
      ORDER BY expression						 # å¨è¿æ¥ä¹åæååºæéåºæåºå¼
      SEPARATOR sep);								 # æå®å¨ç»ä¸­çå¼ä¹é´æå¥çæå­å¼ãå¦æä¸æå®åéç¬¦ï¼åGROUP_CONCATå½æ°ä½¿ç¨éå·(ï¼)ä½ä¸ºé»è®¤åéç¬¦ã
  ```

- `LENGTH()`: return the string length in "bytes"

  `CHAR_LENGTH()`: return the string length in "characters"

  --> especially relevant for Unicode (most characters are encoded in two bytes) and UTF-8 (the number of bytes varies)

  ```sql
  select length(_utf8 'â¬'), char_length(_utf8 'â¬')
  # --> 3, 1
  ```

## 5. MySQL Numeric Functions

- `ROUND(number, num of decimals)`: round a number to a specified number of decimal places
- `SUM(expression)` --> **Note:** NULL values are ignored.

## 6. MySQL Date Functions

- `DATEDIFF()`: return the <u>number of days</u> between two date values --> `DATEDIFF(date1, date2) = date1 - date2` åå«è´å¼ 

- `DATE_FORMAT(date, format)`: format a date as specified --> `DATE_FORMAT("2017-06-15", "%Y")`

  ![image-20230718095107059](/Users/xinyuzhang/Library/Application%20Support/typora-user-images/image-20230718095107059.png)

- `DATE_SUB(date, INTERVAL value interval)`: subtract a time/date interval from a date and then return the date

  Eg. `SELECT DATE_SUB("2017-06-15 09:34:21", INTERVAL 15 MINUTE);`

  <img src="/Users/xinyuzhang/Library/Application%20Support/typora-user-images/image-20230724093106481.png" alt="image-20230724093106481" style="zoom:50%;" />

## 7. MySQL Advanced Functions

- `ISNULL(expression, value)`: If `expression` is NULL, return `value` --> replace values with the value we want

- `SELECT IFNULL(expression, alt_value)`: If `expression` is NULL, return `alt_value`; if `expression` is not NULL, keep the value of `expression`

- `IF(condition, value_if_true, value_if_false)`: return the second parameter if a condition is TRUE, return the third parameter if a condition is FALSE

- `CAST(expression AS datatype(length))`: convert a value (of any type) into a specified datatype
  - Datatype: bigint, int, smallint, tinyint, bit, decimal, numeric, money, smallmoney, float, real, datetime, smalldatetime, char, varchar, text, nchar, nvarchar, ntext, binary, varbinary, or image

- **Regular Expressions (Regexp)**: a pattern matching operation in SQL

  <img src="../../../../Library/Application%20Support/typora-user-images/image-20240111143424573.png" alt="image-20240111143424573" style="zoom:50%;" />

  Example:

  ```sql
  SELECT name FROM person_tbl WHERE name REGEXP '^st';
  ```

## 8. MySQL Window Function

- **æ¦å¿µ**

  çªå£å½æ°ï¼åæ¬ä¸¤ä¸ªåå®¹ï¼ä¸ä¸ªæ¯**çªå£**ï¼è¦æç½çªå£çæ¦å¿µï¼å¦ä¸ä¸ªæ¯**å½æ°**ï¼ç¹æåºç¨å¨çªå£ä¸çå½æ°ã<font color=blue>**çªå£å®ç°æ°æ®éæ©ï¼å½æ°å®ç°æ°æ®å¤çã**</font>

  `å½æ°åï¼å­æ®µåï¼OVERï¼å­å¥ï¼`

  å½æ°åæ°é¨åå¡«éè¦è¢«å å·¥çå­æ®µåç§°ï¼overæ¯å³é®å­ï¼ç¨æ¥æå®å½æ°æ§è¡ççªå£èå´ï¼åå«ä¸ä¸ªåæå­å¥ï¼

  1. åç»å­å¥ï¼partiton by <è¦ååçç»>
  2. æåºå­å¥ï¼order by <è¦æåºçå>
  3. çªå£å­å¥ï¼rows between <æ°æ®èå´> --> éå®å·ä½çªå£å¤§å°

  `å½æ°å(å­æ®µå) over(partiton by <è¦ååçç»> order by <è¦æåºçå> rows between <æ°æ®èå´>)`

  ![çªå£å½æ°](https://lusuzi.com/images/%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/window_func.svg)

- **æ°æ®éæ©**

  group byåç»ååçæ¯**æ´ç»èåè¿ç®**ï¼åç»éå¦ææå¤ä¸ªè¡å¤çåæç»åªä¼æä¸è¡è¿åï¼èpartition byå®åç»ååçæ¯<font color=blue>**éè¡æçªå£è®¡ç®**ï¼ä¸ç®¡ç¨ä»ä¹å½æ°å¤çï¼ä¸è¡è®°å½å¾å°ä¸è¡è®°å½ï¼è¿åçè¡è¿æ¯é£ä¹å¤ --> éç¨äºè¿è¡æ»å¨è¿ç®æ¶ï¼</font>ã

  ```sql
  rows between 2 preceding and current row         # åå½åè¡ååé¢è¡
  rows between unbounded preceding and current row # åæ¬æ¬è¡åä¹åææçè¡
  rows between current row and unbounded following # åæ¬æ¬è¡åä¹åææçè¡
  rows between 3 preceding and current row         # åæ¬æ¬è¡ååé¢ä¸è¡
  rows between 3 preceding and 1 following         # ä»åé¢ä¸è¡åä¸é¢ä¸è¡,æ»å±äºè¡
  ```

  <img src="https://lusuzi.com/images/%E4%B8%80%E6%96%87%E6%90%9E%E6%87%82%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/image-20220218222650750.png" alt="image-20220218222650750" style="zoom:50%;" />

- **æ°æ®å¤ç**

  - <u>1. ä¸æå½æ°</u>: çªå£ç¯å¢ä¸ä¸æçå½æ°ï¼ä¸»è¦ææåºå½æ°ä¸å·¨å¤´ï¼åç§»å½æ°ï¼ååå½æ°ntile

    1. `rank()`ï¼ä¸ºè·³è·æåºï¼ç»æç¸åçä¸¤ä¸ªæ°æ®å¹¶åï¼ä¾å¦å¹¶åç¬¬ä¸ï¼åä¸º1134
    2. `dense_rank()`ï¼ä¸ºæéå¤çè¿ç»­æåºï¼ç»æç¸åçä¸¤ä¸ªæ°æ®å¹¶åï¼ä¾å¦å¹¶åç¬¬ä¸ï¼åä¸º1123
    3. `row_number()`ï¼ä¸ºä¸éå¤çè¿ç»­æåºï¼ä¾å¦å¹¶åç¬¬ä¸ï¼ç§æ ·ä¸º1234
    4. `ntile(n)`ï¼ç¨äºå°åç»æ°æ®å¹³åååænåï¼å¦æååçæ¯ç»æ°éä¸åç­ï¼åç¬¬ä¸ç»åå¾çæ°æ®æ´å¤
    5. åç§»å½æ°ï¼ç¨äºååºåä¸å­æ®µçåNè¡æ°æ®æåNè¡æ°æ®ï¼ä½ä¸ºåç¬çåï¼åå«æ¯`lead(str, n, default)`å`lag(str, n, default)`ï¼nè¡¨ç¤ºå/ånè¡æ°æ®,é»è®¤å¼ä¸º1ï¼defaultè¡¨ç¤ºå¦æåå¼èå´å·²ç»è¶è¿æ´ä¸ªè¡¨çè¿åå¼ï¼å¯ä»¥ä¸å¡«ï¼ä¸å¡«é»è®¤è¿åN/A
    6. ä½ç½®å½æ°ï¼ç¨äºååºç¬¬ä¸è¡ç`first_value()`å½æ°åæåä¸è¡ç`last_value()`å½æ°ï¼ä»¥åååºç¬¬nä¸ªç`nth_value(str,n)`å½æ°
    7. åå¸å½æ°ï¼ åæ¬`PERCENT_RANK()`æ¯è¡æç§å¬å¼`(rank-1) / (rows-1)`è¿è¡è®¡ç®ãå¶ä¸­ï¼`rank`ä¸º`RANK()å½æ°`äº§ççåºå·ï¼`rows`ä¸ºå½åçªå£çè®°å½æ»è¡æ°ã`CUME_DIST()`åærank/rowsè¿è¡è®¡ç®ï¼å³å½åè¡çè¡å·/æ»è¡æ°ã

  - <u>2. èåç±»å½æ° Aggregate Window Function</u>ï¼æ®éåºæ¯ä¸ä¸group byä¸èµ·ä½¿ç¨çé£ç±»å½æ°ï¼ä½ç¨ç¸å

    `SUM(), COUNT(), AVERAGE(), MAX(), MIN()`

Window functions applies **aggregate and ranking** functions over a particular window (set of rows). OVER clause is used with window functions to define that window. OVER clause does two things : 

- Partitions rows into form set of rows. (`PARTITION BY` clause is used) 
- Orders rows within those partitions into a particular order. (`ORDER BY` clause is used) 

**Note:** If partitions arenât done, then ORDER BY orders all rows of table. 

```sql
SELECT coulmn_name1, 
 window_function(cloumn_name2)
 OVER([PARTITION BY column_name1] [ORDER BY column_name3]) AS new_column
FROM table_name;
```

- **Aggregate Window Function :** 
  Various aggregate functions such as `SUM(), COUNT(), AVERAGE(), MAX(), MIN()` applied over a particular window (set of rows)

## 9. Attention

- The `WHERE` clause is not only used in `SELECT` statements, it is also used in `UPDATE`, `DELETE`, etc.!

- `WHERE`ä¸`HAVING`çæ ¹æ¬åºå«å¨äºï¼

  - `WHERE`å­å¥å¨`GROUP BY`åç»åèåå½æ°**ä¹å**å¯¹æ°æ®è¡è¿è¡è¿æ»¤ï¼`WHERE`å­å¥ä¸­ä¸è½ä½¿ç¨èåå½æ°ï¼æ¯å¦`COUNT/AVG/SUM`ç­ï¼
  - `HAVING`å­å¥å¯¹`GROUP BY`åç»åèåå½æ°**ä¹å**çæ°æ®è¡è¿è¡è¿æ»¤ã

  ```sql
  select dept_id, count(*)
  from employee
  group by dept_id
  having count(*) > 5;  # or WHERE employee_count > 5;
  ```

- SQLéçindexä»1å¼å§

- å¨å¤è¡¨æ¥è¯¢çæ¶åï¼éè¦ç»è¡¨ä¸ä¸ªå«å --> ä¿è¯æ¯ä¸ªæ´¾ççè¡¨é½æä¸ä¸ªèªå·±çå«å

  - `MIN(event_date) OVER (PARTITION BY player_id) first_login`: å½`OVER`å`	PARTITION BY`åå¨ä¸èµ·æ¶ï¼è¿éææ ¹æ®`player_id` è®¡ç®`MIN(event_date)`ï¼ç»æå½åä¸º`first_login`

- `SELECT DISTINCT`å`GROUP BY`çç¨å¤æ¯ä¸æ ·ç

- `LEFT JOIN`: return all records from the left table (table1), and the matching records from the right table (table2). If there are no matching records from the right table, the value will be <u>NULL</u>. `RIGHT JOIN`ç±»ä¼¼ï¼ä¼åå«å³è¡¨ææçå¼ä»¥åå·¦è¡¨å¯¹åºçå¼ï¼å¦ææ²¡æå¯¹åºå¼åè¿åNULL

- <font color=blue>ä¸å®è¦è®°å¾ä½¿ç¨`LEFTÂ JOIN`å`RIGHTÂ JOIN`çæ¶åè¦ä½¿ç¨`ON`æ`USING`ææèç»çè¡</font>

- Use `CROSS JOIN` and `LEFT JOIN/RIGHT JOIN` to concatenate three tables

  ```sql
  SELECT column_name(s)
  FROM table1 CROSS JOIN table2
  LEFT JOIN table 3 ON ...;
  ```

- å½æå¤è¡¨èç»æ¶ï¼ä½¿ç¨`ORDER BY`ä¸å®è¦æ³¨ææ¯æç§åªå¼ è¡¨çorderæ¥æåºï¼ï¼

- éè¦ä»å¦ä¸ä¸ªè¡¨æåå¼çæ¶åï¼ä¸å®è¦å ä¸`SELECT`ï¼åè®°`SELECT`å`FROM`ç¼ºä¸ä¸å¯ï¼

- `COUNT`å½æ°ç¨äºè®¡ç®è¡æ°ï¼`SUM`å½æ°ç¨äºè®¡ç®æ°å¼çæ»åã å®ä»¬çåºå«å¨äº`COUNT`å½æ°åªè®¡ç®éç©ºå¼ï¼è`SUM`å½æ°åªè½ç¨äºæ°å¼ç±»åçåã

- å½é¢ç®è®¡ç®çç»æéè¦ç­éç¹å®çè¡æ¶ï¼ä½¿ç¨`IN`å`SELECT`èåä½¿ç¨

  ```sql
  # Example
  SELECT ROUND(
          (SUM(order_date = customer_pref_delivery_date) / COUNT(*)) * 100, 
          2) AS immediate_percentage
  FROM Delivery
  WHERE (customer_id, order_date) IN (
          SELECT customer_id, MIN(order_date)
          FROM Delivery
          GROUP BY customer_id
  )
  ```

- å¦æé¢ç®æéæ©ææ©/ææçæ¥ææ¶ï¼èèä½¿ç¨`MIN()/MAX()`æå

- é¢ç®ä¸­åå«running sum/runnning count/rolling averageç­ï¼èèä½¿ç¨window function!

- `COUNT(column)`: æ ¹æ®æå®çåç»è®¡è®°å½æ»æ°ï¼åå«éå¤çè®°å½ï¼ä¸åæ¬NULLæç©ºçå¼                           --> è®¡ç®è¯¥åä¸å±æå¤å°èª

  `COUNT(DISTINCT column)`: æ ¹æ®æå®çåç»è®¡è®°å½æ»æ°ï¼ä¸åå«éå¤çè®°å½ï¼ä¸åæ¬NULLæç©ºçå¼     --> å¦ææè¡çå¼ä¸æ ·ï¼ååªè®¡ç®ä¸æ¬¡

- å¦æå¨æ²¡æ¾å°ç¸å³çrowæ¶ï¼å¸æè¿åno rowsèä¸æ¯è¿åå¸¦æNULLçè¡ï¼ä½¿ç¨group byï¼è¿æ ·è¡¨ä¼åªè¿åå­å¨æå¼çæ¶å

- Joinè¿æ¥åï¼Unionè¿æ¥è¡ --> å¦æææ³ç­åºåºå¤ç§æåµçï¼å¯ä»¥ä½¿ç¨`UNION`ï¼èåæ¥è¯¢ UNION æ¯èªå¨å»éç

- `CASE`å¨`SELECT`è¯­å¥éçç¨æ³ï¼

  ```sql
  SELECT *, 
      # create a new column
      CASE 
          WHEN x + y > z AND x + z > y AND y + z > x THEN 'Yes'
          ELSE 'No'
      END AS triangle 
  FROM Triangle
  ```


- å¦ææ³åå»ºä¸å¼ æ°è¡¨è¿è¡èç»ï¼

  ```sql
  WITH Category AS (
      SELECT "Low Salary" AS category
      UNION
      SELECT "Average Salary" AS category
      UNION
      SELECT "High Salary" AS category
  )
  ```

- è®¡ç®è¡¨æ ¼è¡æ°ï¼`SELECT COUNT(*) FROM table`
- `FROM CONCAT(lat, lon) IN `: å¦ææ³è¡¨è¾¾å¤ä¸ªåéçç­éä½¿ç¨`IN`æ¶ï¼è¦ä½¿ç¨`CONCAT`!
- ä½¿ç¨çªå£å½æ°æ¶ï¼ä¸å®è¦æ³¨æå½æ°å`OVER`åè¦å ()ï¼ï¼
- æ³¨æ`SELECT`çæåä¸ä¸ªååä¸è¦éå·ï¼
- **Regular Expressions:** A valid e-mail has a prefix name and a domain where:

  - **The prefix name** is a string that may contain letters (upper or lower case), digits, underscore `'_'`, period `'.'`, and/or dash `'-'`. The prefix name **must** start with a letter.

  - **The domain** is `'@leetcode.com'`.

  Solution: `WHERE mail REGEXP '^[A-Za-z][A-Za-z0-9_.-]*@leetcode[.]com$'`

  è®°å¾å¨æ­£åè¡¨è¾¾å¼éï¼`.,-,_,\`ç¬¦å·é½è¦escapeï¼å¯ä»¥æ¾å¨`[]`éæè`\.`

- å½é¢ç®æ¯highest/second highestç­æåºæ¶ï¼ä½¿ç¨`DENSE_RANK()`æ`RANK()`åé æåºåï¼åè¿è¡ç­é

- SQLåå»ºå½æ°:

  ```sql
  CREATE FUNCTION getNthHighestSalary(N INT) RETURNS INT
  BEGIN
    RETURN (
        # Write your MySQL query statement below.
        SELECT DISTINCT salary
        FROM (
            SELECT *, DENSE_RANK() OVER(ORDER BY salary DESC) AS rnk
            FROM Employee
        ) t
        WHERE rnk = N  
    );
  END
  ```

- å¦æé¢ç®è¦æ±åçåç§°ä¸ºSQLèªå¸¦å½æ°çåç§°ï¼å¯ä»¥æ·»å `''`è¡¨ç¤ºåå­æ¯string
